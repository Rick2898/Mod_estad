---
title: "Evaluaci√≥n de la oferta inmobiliaria urbana (Actividad 1)"
author: "Ricardo Vargas Murillo"
date: "2026-02-12"
output: html_document
---
#1. Introducci√≥n

Problema: una inmobiliaria necesita entender el mercado urbano para mejorar la valoraci√≥n (pricing) y decisiones de compra/venta.
Objetivo: usar an√°lisis estad√≠stico multivariado para (i) identificar factores dominantes (PCA), (ii) segmentar inmuebles (clustering), (iii) estudiar asociaciones entre variables categ√≥ricas (correspondencia) y (iv) visualizar resultados (gr√°ficos y mapa).


```{r, setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```



```{r}
library(paqueteMODELOS)
data("vivienda")
df <- vivienda

library(tidyverse)
library(janitor)
library(skimr)
library(ggplot2)
library(forcats)
library(dplyr)
library(stringr)
library(stringi)
library(janitor)
library(mice)
library(factoextra)
library(cluster)
library(factoextra)
library(FactoMineR)


```


```{r}
df <- df %>% clean_names()
glimpse(df)
```
Aca podemos identificar que las variables son las siguientes: 

- Variables num√©ricas: estrato, preciom, areaconst, parqueaderos, banios, habitaciones, longitud, latitud (id es identificador, no variable explicativa).
- Variables categ√≥ricas: zona, piso, tipo, barrio.

```{r}
n0 <- nrow(df)
df <- df %>% distinct()
n1 <- nrow(df)
tibble(
  filas_iniciales = n0,
  filas_despues = n1,
  duplicadas_removidas = n0 - n1
)
```

```{r}
na_tab <- df %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "n_na") %>%
  arrange(desc(n_na))
na_tab
```

- Las variables con mayor proporci√≥n de faltantes son `piso` (~31.7%) y `parqueaderos` (~19.3%).  
- Esto obliga a un tratamiento cuidadoso: `piso` se usar√° como categ√≥rica ‚ÄúSin dato‚Äù para correspondencia; `parqueaderos` se imputar√° para no perder informaci√≥n en segmentaci√≥n.


```{r}
df <- df %>%
  mutate(
    zona = as.factor(zona),
    tipo = as.factor(tipo),
    barrio = as.factor(barrio),
    piso_cat = fct_explicit_na(as.factor(piso), na_level = "Sin dato"),
    estrato = as.numeric(estrato)
  )
```

```{r}
df <- df %>%
  mutate(
    barrio_txt = as.character(barrio),
    barrio_txt = str_squish(barrio_txt),
    barrio_txt = str_to_lower(barrio_txt),
    barrio_txt = stri_trans_general(barrio_txt, "Latin-ASCII"),
    barrio_txt = if_else(barrio_txt == "ponce", "pance", barrio_txt),
    barrio_txt = if_else(barrio_txt == "laflora", "la flora", barrio_txt)
  ) %>%
  filter(!is.na(barrio_txt)) %>%
  filter(!(barrio_txt %in% c("santa", "norte"))) %>%
  mutate(barrio = as.factor(barrio_txt)) %>%
  select(-barrio_txt)
```

Ya normalizamos barrio para que no tenga minusculas ni tildes ni espacios y evitar duplicados

continuaremos con el histograma

```{r}
ggplot(df, aes(x = preciom)) +
  geom_histogram(bins = 40) +
  labs(title = "Distribuci√≥n del precio por m¬≤", x = "preciom", y = "Frecuencia")
```



El precio por m¬≤ es asim√©trico (cola a la derecha): hay pocos inmuebles muy caros. Esto sugiere segmentaci√≥n del mercado.

```{r}
ggplot(df, aes(x = areaconst, y = preciom)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  labs(title = "Precio vs √Årea construida", x = "√Årea construida", y = "Precio por m¬≤")

```
Se observa relaci√≥n positiva general: a mayor √°rea, tiende a cambiar el precio por m¬≤ (no siempre lineal; depende de zona/estrato).

```{r}
ggplot(df, aes(x = zona, y = preciom)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 25, hjust = 1)) +
  labs(title = "Precio por zona", x = "Zona", y = "preciom")
```
```{r}
ggplot(df, aes(x = tipo, y = preciom)) +
  geom_boxplot() +
  labs(title = "Precio por tipo de vivienda", x = "Tipo", y = "preciom")
```
Existen diferencias de precio por zona y tipo, lo que apoya usar t√©cnicas multivariadas y segmentaci√≥n

```{r}
df_imp <- df %>%
  mutate(parqueaderos = as.numeric(parqueaderos)) %>%
  select(-piso) # piso original no lo usamos; usamos piso_cat

# Configurar MICE
ini  <- mice(df_imp, maxit = 0)
meth <- ini$method
pred <- ini$predictorMatrix

# M√©todo para parqueaderos
meth["parqueaderos"] <- "pmm"

# No usar id como predictor si existe
if ("id" %in% colnames(pred)) pred[, "id"] <- 0

set.seed(123)
imp <- mice(df_imp, method = meth, predictorMatrix = pred, m = 5, seed = 123)
df2 <- complete(imp, 1)
```
Como `parqueaderos` tiene ~19% de faltantes y es importante para valorar, se usa imputaci√≥n m√∫ltiple (MICE) con **pmm** para conservar la distribuci√≥n y evitar sesgos.

```{r}
ggplot() +
  geom_density(data = df,  aes(x = parqueaderos), na.rm = TRUE) +
  geom_density(data = df2, aes(x = parqueaderos), na.rm = TRUE) +
  labs(title = "Densidad parqueaderos: antes vs despues de imputacion",
       x = "parqueaderos", y = "densidad")
```
Continuaremos con el PCA

```{r}



# Variables num√©ricas que s√≠ describen el inmueble (EXCLUIMOS id)
vars_num <- c("estrato","preciom","areaconst","parqueaderos","banios","habitaciones","longitud","latitud")

df_pca <- df2 %>% select(all_of(vars_num)) %>% drop_na()

# Estandarizaci√≥n para evitar sesgos por escalas distintas
Xz <- scale(df_pca)

# PCA
pca <- prcomp(Xz, center = TRUE, scale. = FALSE)
```


```{r}
fviz_eig(pca, addlabels = TRUE) +
  labs(title = "PCA: Varianza explicada por componente")
```
El primer componente principal (PC1) explica 45.7 de la variabilidad
Los dos primeros componentes (PC1 + PC2) explican 64.3% acumulado
Por lo tanto, el plano PC1‚ÄìPC2 permite un resumen inicial del mercado, aunque puede requerirse PC3 para capturar m√°s variaci√≥n

```{r}
eig <- get_eigenvalue(pca)
eig
```



```{r}
round(pca$rotation[,1:2], 3)

```
```{r}
fviz_pca_var(pca,
             col.var = "contrib",
             gradient.cols = c("#FF7F00", "#034D94"),
             repel = TRUE) +
  labs(title = "PCA: Contribucion de variables a PC1 y PC2")
```
El primer componente principal (45.7% de la varianza) est√° asociado principalmente con las variables precio por m¬≤, n√∫mero de ba√±os, √°rea construida, parqueaderos y estrato. Esto sugiere que PC1 captura un eje de valorizaci√≥n y nivel socioecon√≥mico del inmueble.

El segundo componente principal (18.6%) est√° asociado principalmente con n√∫mero de habitaciones y variables geogr√°ficas (latitud y longitud), representando un eje de diferenciaci√≥n espacial y estructural.

En conjunto, PC1 y PC2 explican el 64.3% de la variabilidad del mercado, lo que permite una representaci√≥n bidimensional adecuada para an√°lisis exploratorio.

```{r}
df <- df %>%
  mutate(
    piso_cat = forcats::fct_explicit_na(as.factor(piso), na_level = "Sin dato")
  )



```


```{r}
# 1) Tomo parqueaderos imputado desde df2
parq_imp <- df2 %>% select(id, parqueaderos)

# 2) Reemplazo parqueaderos en df usando el imputado 
df_clust_base <- df %>%
  select(id, zona, tipo, barrio, piso_cat, estrato, preciom, areaconst,
         banios, habitaciones, longitud, latitud, parqueaderos) %>%
  left_join(parq_imp, by = "id", suffix = c("_orig", "_imp")) %>%
  mutate(parqueaderos = parqueaderos_imp) %>%
  select(-parqueaderos_orig, -parqueaderos_imp)

# Variables num√©ricas para clustering
vars_num <- c("estrato","preciom","areaconst","parqueaderos",
              "banios","habitaciones","longitud","latitud")

df_clust <- df_clust_base %>% drop_na(all_of(vars_num))

# Estandarizar 
Xc <- scale(df_clust %>% select(all_of(vars_num)))
```

Se usa `parqueaderos` imputado para no perder observaciones
Se estandarizan variables para calcular distancias sin sesgo por escala

```{r}
dist_eucl <- dist(Xc, method = "euclidean")
hc <- hclust(dist_eucl, method = "average")

plot(hc, cex = 0.4, main = "Dendrograma (average)", xlab = "", sub = "")

```
Elegir k con Silhouette (k = 2 a 8)

```{r}
sil_means <- tibble(k = 2:8, sil = NA_real_)

for (i in 2:8) {
  grp <- cutree(hc, k = i)
  sil <- silhouette(grp, dist_eucl)
  sil_means$sil[sil_means$k == i] <- mean(sil[,3])
}

sil_means

ggplot(sil_means, aes(k, sil)) +
  geom_line() + geom_point() +
  labs(title = "Silhouette promedio por k", x = "k", y = "Silhouette promedio")

k_final <- sil_means$k[which.max(sil_means$sil)]
k_final

```
```{r}
df_clust <- df_clust %>%
  mutate(cluster = factor(cutree(hc, k = k_final)))

plot(hc, cex = 0.4, main = paste("Dendrograma con k =", k_final))
rect.hclust(hc, k = k_final, border = 2:(k_final+1))

```
```{r}
perfil <- df_clust %>%
  group_by(cluster) %>%
  summarise(
    n = n(),
    preciom_med = median(preciom),
    preciom_p25 = quantile(preciom, 0.25),
    preciom_p75 = quantile(preciom, 0.75),
    estrato_med = median(estrato),
    area_med = median(areaconst),
    banios_med = median(banios),
    parq_med = median(parqueaderos),
    hab_med = median(habitaciones),
    .groups = "drop"
  ) %>%
  arrange(desc(n))

perfil

```
Se evalu√≥ el n√∫mero de conglomerados k=2‚Ä¶8 usando el √≠ndice Silhouette promedio. El valor m√°ximo se obtuvo en k=2 (0.616), indicando la partici√≥n m√°s coherente desde el punto de vista estad√≠stico.

```{r}
# Soluci√≥n alternativa para segmentaci√≥n √∫til
k_alt <- 3
df_clust_k3 <- df_clust %>% mutate(cluster3 = factor(cutree(hc, k = k_alt)))

perfil3 <- df_clust_k3 %>%
  group_by(cluster3) %>%
  summarise(
    n = n(),
    preciom_med = median(preciom),
    preciom_p25 = quantile(preciom, 0.25),
    preciom_p75 = quantile(preciom, 0.75),
    estrato_med = median(estrato),
    area_med = median(areaconst),
    banios_med = median(banios),
    parq_med = median(parqueaderos),
    hab_med = median(habitaciones),
    .groups = "drop"
  ) %>%
  arrange(preciom_med)

perfil3

```
```{r}
# Obtener coordenadas PCA
df_pca_coords <- as.data.frame(pca$x[,1:2])

# Agregar cluster k=3
df_pca_coords$cluster3 <- df_clust_k3$cluster3

ggplot(df_pca_coords, aes(x = PC1, y = PC2, color = cluster3)) +
  geom_point(alpha = 0.5) +
  labs(title = "Clusters (k=3) proyectados en plano PCA",
       x = "PC1",
       y = "PC2") +
  theme_minimal()


```
```{r}
ggplot(df_clust_k3, aes(x = areaconst, y = preciom, color = cluster3)) +
  geom_point(alpha = 0.6) +
  labs(title = "Clusters seg√∫n √°rea y precio",
       x = "√Årea construida",
       y = "Precio por m¬≤") +
  theme_minimal()

```
```{r}
# Quitar outliers extremos (ejemplo percentil 99)
df_filtrado <- df_clust %>%
  filter(preciom < quantile(preciom, 0.99))

Xf <- scale(df_filtrado %>% select(all_of(vars_num)))
hc_f <- hclust(dist(Xf), method = "average")

fviz_nbclust(Xf, FUN = hcut, method = "silhouette")

```



La soluci√≥n √≥ptima seg√∫n el √≠ndice Silhouette fue k=2, lo cual separa el mercado en un grupo masivo y un peque√±o grupo de inmuebles extremos (outliers premium). Sin embargo, para fines estrat√©gicos de segmentaci√≥n comercial se evalu√≥ k=3, donde se distinguen tres niveles: mercado general, segmento alto y segmento ultra-premium. Los clusters muestran una clara diferenciaci√≥n principalmente explicada por precio por m¬≤ y √°rea construida.

Lo que se puede ver con el algoritmo de cluster es que el mercado esta dominado homogeneamente y tiene variabilidad continua no hay segmentacion natural fuerte y el algoritmo esta clasificando fronteras por lo tanto el algoritmo identifica bien outliers

```{r}
tab_ze <- table(df$zona, df$estrato)
tab_ze


```

```{r}
chi_ze <- chisq.test(tab_ze)
chi_ze
```
```{r}
ca_ze <- CA(tab_ze, graph = FALSE)

ca_ze$eig
```
```{r}
fviz_ca_biplot(ca_ze, repel = TRUE) +
  labs(title = "An√°lisis de Correspondencia: Zona vs Estrato")




```


La prueba chi-cuadrado (œá¬≤ = 3839.5, p < 0.001) confirma una asociaci√≥n altamente significativa entre la zona de la ciudad y el estrato socioecon√≥mico.

El an√°lisis de correspondencia gener√≥ tres dimensiones, donde las dos primeras explican el 97.7% de la inercia total (Dim1 = 69.9%, Dim2 = 27.7%), permitiendo una representaci√≥n bidimensional pr√°cticamente completa.

La Dimensi√≥n 1 representa un eje socioecon√≥mico, diferenciando zonas asociadas a estratos bajos (3) de aquellas vinculadas a estratos altos (6).

En particular:

Zona Oeste se asocia fuertemente con estrato 6, caracteriz√°ndose como zona premium.

Zona Oriente y Zona Centro se relacionan principalmente con estrato 3, reflejando un perfil socioecon√≥mico m√°s popular.

Zona Norte y Zona Sur presentan asociaci√≥n con estratos 4 y 5, representando segmentos intermedios del mercado.

Estos resultados evidencian una clara segmentaci√≥n espacial del mercado inmobiliario seg√∫n nivel socioecon√≥mico, lo cual es fundamental para estrategias de pricing, inversi√≥n y desarrollo inmobiliario.


```{r}
# Top 10 barrios con m√°s registros
top_barrios <- df %>%
  count(barrio, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(barrio)

top_barrios

```

```{r}
tab_be <- df %>%
  filter(barrio %in% top_barrios) %>%
  count(barrio, estrato) %>%
  pivot_wider(names_from = estrato, values_from = n, values_fill = 0) %>%
  column_to_rownames("barrio")

tab_be

```
```{r}
chisq.test(tab_be)

```

```{r}
ca_be <- CA(tab_be, graph = FALSE)

ca_be$eig

```

```{r}
fviz_ca_biplot(ca_be, repel = TRUE) +
  labs(title = "An√°lisis de Correspondencia: Top 10 Barrios vs Estrato")

```

El test Chi-cuadrado (X¬≤ = 3734, p < 0.001) indica que existe una asociaci√≥n estad√≠sticamente significativa entre barrio y estrato, rechazando la hip√≥tesis de independencia. Esto confirma que la estructura socioecon√≥mica del mercado inmobiliario presenta una clara diferenciaci√≥n espacial.

La primera dimensi√≥n explica el 72.2% de la variabilidad asociativa, capturando el eje principal de segregaci√≥n socioecon√≥mica. La segunda dimensi√≥n (21.9%) complementa esta diferenciaci√≥n, permitiendo una representaci√≥n bidimensional adecuada (94% acumulado).

El mapa revela que barrios como Pance, Santa Teresita y Ciudad Jard√≠n se encuentran fuertemente asociados a estratos altos, mientras que barrios como Valle del Lili y El Caney presentan un perfil predominantemente medio. La Flora y El Ingenio muestran una asociaci√≥n clara con estrato 5.

Estos resultados evidencian que el mercado inmobiliario urbano presenta patrones estructurales de concentraci√≥n socioecon√≥mica por barrio.


El An√°lisis de Componentes Principales permiti√≥ identificar que:

El primer componente (45.7%) representa un eje de valorizaci√≥n inmobiliaria, asociado a precio por m¬≤, √°rea construida, n√∫mero de ba√±os, parqueaderos y estrato.

El segundo componente (18.6%) captura una diferenciaci√≥n espacial y estructural, relacionada con habitaciones y variables geogr√°ficas (latitud y longitud).

En conjunto, los dos primeros componentes explican el 64.3% de la variabilidad del mercado, lo que indica que el comportamiento inmobiliario puede resumirse principalmente en:

Nivel socioecon√≥mico + Localizaci√≥n espacial.

Esto confirma que el precio no depende solo del tama√±o, sino de la estructura socioecon√≥mica y la ubicaci√≥n.

2Ô∏è‚É£ Segmentaci√≥n del mercado (Clustering)

El an√°lisis de conglomerados mostr√≥ que:

El √≠ndice de Silhouette sugiere que k=2 es el mejor n√∫mero de clusters, aunque con separaci√≥n moderada.

La visualizaci√≥n revela que el mercado est√° altamente concentrado en un gran grupo homog√©neo.

Existe un peque√±o subconjunto de propiedades con caracter√≠sticas extremas (mayor precio, mayor √°rea, mayor estrato).

Interpretaci√≥n clave:

El mercado inmobiliario urbano no presenta m√∫ltiples segmentos claramente separados, sino un n√∫cleo dominante con algunos inmuebles premium que act√∫an como outliers estructurales.

Esto indica que la diferenciaci√≥n ocurre m√°s como gradiente continuo que como bloques r√≠gidos.

3Ô∏è‚É£ Asociaci√≥n espacial socioecon√≥mica (Correspondencia)

El test Chi-cuadrado confirm√≥ una asociaci√≥n altamente significativa entre zona/barrio y estrato (p < 0.001).

El An√°lisis de Correspondencia mostr√≥ que:

La primera dimensi√≥n explica m√°s del 70% de la estructura asociativa.

Existe una clara segregaci√≥n espacial socioecon√≥mica.

Barrios como Pance y Santa Teresita est√°n fuertemente asociados a estratos altos.

Barrios como Valle del Lili y El Caney presentan perfil medio.

Algunos barrios muestran perfiles mixtos.

Conclusi√≥n estructural:

La ciudad presenta una organizaci√≥n espacial claramente diferenciada por nivel socioecon√≥mico.

üî∑ Integraci√≥n global de resultados

Si unimos todo:

M√©todo	Qu√© mostr√≥
PCA	Existe eje de valorizaci√≥n y eje espacial
Clustering	Mercado concentrado con pocos extremos
Correspondencia	Fuerte segregaci√≥n socioecon√≥mica espacial

Eso significa que:

‚úî El mercado tiene una estructura continua de valorizaci√≥n
‚úî La localizaci√≥n explica gran parte del comportamiento
‚úî No hay muchos ‚Äúsegmentos puros‚Äù, sino gradientes
‚úî La estructura socioecon√≥mica est√° territorialmente definida

üî∑ Conclusi√≥n estrat√©gica para la inmobiliaria

Desde una perspectiva aplicada:

La valoraci√≥n debe considerar ubicaci√≥n y estrato como variables estructurales.

El mercado no requiere segmentaci√≥n excesiva; bastan grandes categor√≠as.

Existen nichos premium claramente identificables.

La estructura socioecon√≥mica territorial influye directamente en precios.

üî∑ Conclusi√≥n acad√©mica final (para cerrar con elegancia)

El an√°lisis multivariado evidencia que el mercado inmobiliario urbano presenta una estructura organizada principalmente en torno a un eje de valorizaci√≥n socioecon√≥mica y una diferenciaci√≥n espacial significativa. Aunque el mercado muestra alta concentraci√≥n en un n√∫cleo dominante, existen perfiles extremos que configuran subsegmentos de alto valor. La fuerte asociaci√≥n entre barrio y estrato confirma la existencia de patrones estructurales de segregaci√≥n socioecon√≥mica territorial.
