---
title: "Evaluación de la oferta inmobiliaria urbana (Actividad 1)"
author: "Ricardo Vargas Murillo"
date: "2026-02-12"
output: 
  html_document:
    code_folding: show
---
#1. Introducción

Problema: una inmobiliaria necesita entender el mercado urbano para mejorar la valoración (pricing) y decisiones de compra/venta.
Objetivo: usar análisis estadístico multivariado para (i) identificar factores dominantes (PCA), (ii) segmentar inmuebles (clustering), (iii) estudiar asociaciones entre variables categóricas (correspondencia) y (iv) visualizar resultados (gráficos y mapa).


```{r, configuración, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

```



```{r, carga de librerias, message=FALSE, warning=FALSE}
library(paqueteMODELOS)
data("vivienda")
df <- vivienda

library(tidyverse)
library(janitor)
library(skimr)
library(ggplot2)
library(forcats)
library(dplyr)
library(stringr)
library(stringi)
library(janitor)
library(mice)
library(factoextra)
library(cluster)
library(factoextra)
library(FactoMineR)


```


```{r, variables,message=FALSE, warning=FALSE}
df <- df %>% clean_names()
glimpse(df)
```
Aca podemos identificar que las variables son las siguientes: 

- Variables numéricas: estrato, preciom, areaconst, parqueaderos, banios, habitaciones, longitud, latitud (id es identificador, no variable explicativa).
- Variables categóricas: zona, piso, tipo, barrio.

```{r, duplicados,message=FALSE, warning=FALSE}
n0 <- nrow(df)
df <- df %>% distinct()
n1 <- nrow(df)
tibble(
  filas_iniciales = n0,
  filas_despues = n1,
  duplicadas_removidas = n0 - n1
)
```

```{r, tabla nan,message=FALSE, warning=FALSE}
na_tab <- df %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "n_na") %>%
  arrange(desc(n_na))
na_tab
```

- Las variables con mayor proporción de faltantes son `piso` (~31.7%) y `parqueaderos` (~19.3%).  
- Esto obliga a un tratamiento cuidadoso: `piso` se usará como categórica “Sin dato” para correspondencia; `parqueaderos` se imputará para no perder información en segmentación.


```{r, tratamiento nan,message=FALSE, warning=FALSE}
df <- df %>%
  mutate(
    zona = as.factor(zona),
    tipo = as.factor(tipo),
    barrio = as.factor(barrio),
    piso_cat = fct_explicit_na(as.factor(piso), na_level = "Sin dato"),
    estrato = as.numeric(estrato)
  )
```

```{r, normalizacion,message=FALSE, warning=FALSE}
df <- df %>%
  mutate(
    barrio_txt = as.character(barrio),
    barrio_txt = str_squish(barrio_txt),
    barrio_txt = str_to_lower(barrio_txt),
    barrio_txt = stri_trans_general(barrio_txt, "Latin-ASCII"),
    barrio_txt = if_else(barrio_txt == "ponce", "pance", barrio_txt),
    barrio_txt = if_else(barrio_txt == "laflora", "la flora", barrio_txt)
  ) %>%
  filter(!is.na(barrio_txt)) %>%
  filter(!(barrio_txt %in% c("santa", "norte"))) %>%
  mutate(barrio = as.factor(barrio_txt)) %>%
  select(-barrio_txt)
```

Ya normalizamos barrio para que no tenga minusculas ni tildes ni espacios y evitar duplicados

continuaremos con el histograma

```{r, plot distribucion,message=FALSE, warning=FALSE}
ggplot(df, aes(x = preciom)) +
  geom_histogram(bins = 40) +
  labs(title = "Distribución del precio por m²", x = "preciom", y = "Frecuencia")
```



El precio por m² es asimétrico (cola a la derecha): hay pocos inmuebles muy caros. Esto sugiere segmentación del mercado.

```{r, plot precio vs area,message=FALSE, warning=FALSE}
ggplot(df, aes(x = areaconst, y = preciom)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = "lm") +
  labs(title = "Precio vs Área construida", x = "Área construida", y = "Precio por m²")

```




Se observa relación positiva general: a mayor área, tiende a cambiar el precio por m² (no siempre lineal; depende de zona/estrato).

```{r, boxplot zona,message=FALSE, warning=FALSE}
ggplot(df, aes(x = zona, y = preciom)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 25, hjust = 1)) +
  labs(title = "Precio por zona", x = "Zona", y = "preciom")
```
```{r, boxplot tipo de vivienda,message=FALSE, warning=FALSE}
ggplot(df, aes(x = tipo, y = preciom)) +
  geom_boxplot() +
  labs(title = "Precio por tipo de vivienda", x = "Tipo", y = "preciom")
```




Existen diferencias de precio por zona y tipo, lo que apoya usar técnicas multivariadas y segmentación

```{r, MICE,message=FALSE, warning=FALSE}
df_imp <- df %>%
  mutate(parqueaderos = as.numeric(parqueaderos)) %>%
  select(-piso) # piso original no lo usamos; usamos piso_cat

# Configurar MICE
ini  <- mice(df_imp, maxit = 0)
meth <- ini$method
pred <- ini$predictorMatrix

# Método para parqueaderos
meth["parqueaderos"] <- "pmm"

# No usar id como predictor si existe
if ("id" %in% colnames(pred)) pred[, "id"] <- 0

set.seed(123)
imp <- mice(df_imp, method = meth, predictorMatrix = pred, m = 5, seed = 123)
df2 <- complete(imp, 1)
```
Como `parqueaderos` tiene ~19% de faltantes y es importante para valorar, se usa imputación múltiple (MICE) con **pmm** para conservar la distribución y evitar sesgos.

```{r, grafica de densisdad,message=FALSE, warning=FALSE}
ggplot() +
  geom_density(data = df,  aes(x = parqueaderos), na.rm = TRUE) +
  geom_density(data = df2, aes(x = parqueaderos), na.rm = TRUE) +
  labs(title = "Densidad parqueaderos: antes vs despues de imputacion",
       x = "parqueaderos", y = "densidad")
```
Continuaremos con el PCA

```{r, PCA,message=FALSE, warning=FALSE}



# Variables numéricas que sí describen el inmueble (EXCLUIMOS id)
vars_num <- c("estrato","preciom","areaconst","parqueaderos","banios","habitaciones","longitud","latitud")

df_pca <- df2 %>% select(all_of(vars_num)) %>% drop_na()

# Estandarización para evitar sesgos por escalas distintas
Xz <- scale(df_pca)

# PCA
pca <- prcomp(Xz, center = TRUE, scale. = FALSE)
```


```{r, grafica de PCA,message=FALSE, warning=FALSE}
fviz_eig(pca, addlabels = TRUE) +
  labs(title = "PCA: Varianza explicada por componente")
```



El primer componente principal (PC1) explica 45.7 de la variabilidad
Los dos primeros componentes (PC1 + PC2) explican 64.3% acumulado
Por lo tanto, el plano PC1–PC2 permite un resumen inicial del mercado, aunque puede requerirse PC3 para capturar más variación

```{r, valores descriptivos,message=FALSE, warning=FALSE}
eig <- get_eigenvalue(pca)
eig
```



```{r, variables de pca y descripcion,message=FALSE, warning=FALSE}
round(pca$rotation[,1:2], 3)

```
```{r, grafica de vectores,echo=FALSE,include= TRUE, results='hide'}
fviz_pca_var(pca,
             col.var = "contrib",
             gradient.cols = c("#FF7F00", "#034D94"),
             repel = TRUE) +
  labs(title = "PCA: Contribucion de variables a PC1 y PC2")
```



El primer componente principal (45.7% de la varianza) está asociado principalmente con las variables precio por m², número de baños, área construida, parqueaderos y estrato. Esto sugiere que PC1 captura un eje de valorización y nivel socioeconómico del inmueble.

El segundo componente principal (18.6%) está asociado principalmente con número de habitaciones y variables geográficas (latitud y longitud), representando un eje de diferenciación espacial y estructural.

En conjunto, PC1 y PC2 explican el 64.3% de la variabilidad del mercado, lo que permite una representación bidimensional adecuada para análisis exploratorio.

```{r, modificacion df,message=FALSE, warning=FALSE}
df <- df %>%
  mutate(
    piso_cat = forcats::fct_explicit_na(as.factor(piso), na_level = "Sin dato")
  )



```
Se continuara con el analisis de cluster de la siguiente forma: 

```{r, variables para cluster,message=FALSE, warning=FALSE}
# 1) Tomo parqueaderos imputado desde df2
parq_imp <- df2 %>% select(id, parqueaderos)

# 2) Reemplazo parqueaderos en df usando el imputado 
df_clust_base <- df %>%
  select(id, zona, tipo, barrio, piso_cat, estrato, preciom, areaconst,
         banios, habitaciones, longitud, latitud, parqueaderos) %>%
  left_join(parq_imp, by = "id", suffix = c("_orig", "_imp")) %>%
  mutate(parqueaderos = parqueaderos_imp) %>%
  select(-parqueaderos_orig, -parqueaderos_imp)

# Variables numéricas para clustering
vars_num <- c("estrato","preciom","areaconst","parqueaderos",
              "banios","habitaciones","longitud","latitud")

df_clust <- df_clust_base %>% drop_na(all_of(vars_num))

# Estandarizar 
Xc <- scale(df_clust %>% select(all_of(vars_num)))
```

Se usa `parqueaderos` imputado para no perder observaciones
Se estandarizan variables para calcular distancias sin sesgo por escala

```{r, Dendograma,message=FALSE, warning=FALSE}
dist_eucl <- dist(Xc, method = "euclidean")
hc <- hclust(dist_eucl, method = "average")

plot(hc, cex = 0.4, main = "Dendrograma (average)", xlab = "", sub = "")

```
Elegir k con Silhouette (k = 2 a 8)

```{r, medida silhouette,message=FALSE, warning=FALSE}
sil_means <- tibble(k = 2:8, sil = NA_real_)

for (i in 2:8) {
  grp <- cutree(hc, k = i)
  sil <- silhouette(grp, dist_eucl)
  sil_means$sil[sil_means$k == i] <- mean(sil[,3])
}

sil_means

ggplot(sil_means, aes(k, sil)) +
  geom_line() + geom_point() +
  labs(title = "Silhouette promedio por k", x = "k", y = "Silhouette promedio")

k_final <- sil_means$k[which.max(sil_means$sil)]
k_final

```
```{r, dendograma k2,message=FALSE, warning=FALSE}
df_clust <- df_clust %>%
  mutate(cluster = factor(cutree(hc, k = k_final)))

plot(hc, cex = 0.4, main = paste("Dendrograma con k =", k_final))
rect.hclust(hc, k = k_final, border = 2:(k_final+1))

```
```{r, Tbla n,message=FALSE, warning=FALSE}
perfil <- df_clust %>%
  group_by(cluster) %>%
  summarise(
    n = n(),
    preciom_med = median(preciom),
    preciom_p25 = quantile(preciom, 0.25),
    preciom_p75 = quantile(preciom, 0.75),
    estrato_med = median(estrato),
    area_med = median(areaconst),
    banios_med = median(banios),
    parq_med = median(parqueaderos),
    hab_med = median(habitaciones),
    .groups = "drop"
  ) %>%
  arrange(desc(n))

perfil

```
Se evaluó el número de conglomerados k=2…8 usando el índice Silhouette promedio. El valor máximo se obtuvo en k=2 (0.616), indicando la partición más coherente desde el punto de vista estadístico.

```{r, alternativa,message=FALSE, warning=FALSE}
# Solución alternativa para segmentación útil
k_alt <- 3
df_clust_k3 <- df_clust %>% mutate(cluster3 = factor(cutree(hc, k = k_alt)))

perfil3 <- df_clust_k3 %>%
  group_by(cluster3) %>%
  summarise(
    n = n(),
    preciom_med = median(preciom),
    preciom_p25 = quantile(preciom, 0.25),
    preciom_p75 = quantile(preciom, 0.75),
    estrato_med = median(estrato),
    area_med = median(areaconst),
    banios_med = median(banios),
    parq_med = median(parqueaderos),
    hab_med = median(habitaciones),
    .groups = "drop"
  ) %>%
  arrange(preciom_med)

perfil3

```
```{r, grafico no se ve,message=FALSE, warning=FALSE}
# Obtener coordenadas PCA
df_pca_coords <- as.data.frame(pca$x[,1:2])

# Agregar cluster k=3
df_pca_coords$cluster3 <- df_clust_k3$cluster3

ggplot(df_pca_coords, aes(x = PC1, y = PC2, color = cluster3)) +
  geom_point(alpha = 0.5) +
  labs(title = "Clusters (k=3) proyectados en plano PCA",
       x = "PC1",
       y = "PC2") +
  theme_minimal()


```
```{r, grafico alternativo,message=FALSE, warning=FALSE}
ggplot(df_clust_k3, aes(x = areaconst, y = preciom, color = cluster3)) +
  geom_point(alpha = 0.6) +
  labs(title = "Clusters según área y precio",
       x = "Área construida",
       y = "Precio por m²") +
  theme_minimal()

```
```{r, grafico de clusters optimo,message=FALSE, warning=FALSE}
# Quitar outliers extremos (ejemplo percentil 99)
df_filtrado <- df_clust %>%
  filter(preciom < quantile(preciom, 0.99))

Xf <- scale(df_filtrado %>% select(all_of(vars_num)))
hc_f <- hclust(dist(Xf), method = "average")

fviz_nbclust(Xf, FUN = hcut, method = "silhouette")

```

El analisis de acuerdo con las graficas planteadas es el siguiete

La solución óptima según el índice Silhouette fue k=2, lo cual separa el mercado en un grupo masivo y un pequeño grupo de inmuebles extremos (outliers premium). Sin embargo, para fines estratégicos de segmentación comercial se evaluó k=3, donde se distinguen tres niveles: mercado general, segmento alto y segmento ultra-premium. Los clusters muestran una clara diferenciación principalmente explicada por precio por m² y área construida.

Lo que se puede ver con el algoritmo de cluster es que el mercado esta dominado homogeneamente y tiene variabilidad continua no hay segmentacion natural fuerte y el algoritmo esta clasificando fronteras por lo tanto el algoritmo identifica bien outliers

```{r, tabla1,message=FALSE, warning=FALSE}
tab_ze <- table(df$zona, df$estrato)
tab_ze


```

```{r,chi 1,message=FALSE, warning=FALSE}
chi_ze <- chisq.test(tab_ze)
chi_ze
```
```{r, dimen 1,message=FALSE, warning=FALSE}
ca_ze <- CA(tab_ze, graph = FALSE)

ca_ze$eig
```
```{r, biplot 1,message=FALSE, warning=FALSE}
fviz_ca_biplot(ca_ze, repel = TRUE) +
  labs(title = "Análisis de Correspondencia: Zona vs Estrato")




```


La prueba chi-cuadrado (χ² = 3839.5, p < 0.001) confirma una asociación altamente significativa entre la zona de la ciudad y el estrato socioeconómico.

El análisis de correspondencia generó tres dimensiones, donde las dos primeras explican el 97.7% de la inercia total (Dim1 = 69.9%, Dim2 = 27.7%), permitiendo una representación bidimensional prácticamente completa.

La Dimensión 1 representa un eje socioeconómico, diferenciando zonas asociadas a estratos bajos (3) de aquellas vinculadas a estratos altos (6).

En particular:

Zona Oeste se asocia fuertemente con estrato 6, caracterizándose como zona premium.

Zona Oriente y Zona Centro se relacionan principalmente con estrato 3, reflejando un perfil socioeconómico más popular.

Zona Norte y Zona Sur presentan asociación con estratos 4 y 5, representando segmentos intermedios del mercado.

Estos resultados evidencian una clara segmentación espacial del mercado inmobiliario según nivel socioeconómico, lo cual es fundamental para estrategias de pricing, inversión y desarrollo inmobiliario.


```{r, 10 barrios,message=FALSE, warning=FALSE}
# Top 10 barrios con más registros
top_barrios <- df %>%
  count(barrio, sort = TRUE) %>%
  slice_head(n = 10) %>%
  pull(barrio)

top_barrios

```

```{r, tabla 2,message=FALSE, warning=FALSE}
tab_be <- df %>%
  filter(barrio %in% top_barrios) %>%
  count(barrio, estrato) %>%
  pivot_wider(names_from = estrato, values_from = n, values_fill = 0) %>%
  column_to_rownames("barrio")

tab_be

```
```{r, chi 2,message=FALSE, warning=FALSE}
chisq.test(tab_be)

```

```{r, dimen 2,message=FALSE, warning=FALSE}
ca_be <- CA(tab_be, graph = FALSE)

ca_be$eig

```

```{r, biplot 2,message=FALSE, warning=FALSE}
fviz_ca_biplot(ca_be, repel = TRUE) +
  labs(title = "Análisis de Correspondencia: Top 10 Barrios vs Estrato")

```

El test Chi-cuadrado (X² = 3734, p < 0.001) indica que existe una asociación estadísticamente significativa entre barrio y estrato, rechazando la hipótesis de independencia. Esto confirma que la estructura socioeconómica del mercado inmobiliario presenta una clara diferenciación espacial.

La primera dimensión explica el 72.2% de la variabilidad asociativa, capturando el eje principal de segregación socioeconómica. La segunda dimensión (21.9%) complementa esta diferenciación, permitiendo una representación bidimensional adecuada (94% acumulado).

El mapa revela que barrios como Pance, Santa Teresita y Ciudad Jardín se encuentran fuertemente asociados a estratos altos, mientras que barrios como Valle del Lili y El Caney presentan un perfil predominantemente medio. La Flora y El Ingenio muestran una asociación clara con estrato 5.

Estos resultados evidencian que el mercado inmobiliario urbano presenta patrones estructurales de concentración socioeconómica por barrio.




Desde una perspectiva aplicada:

La valoración debe considerar ubicación y estrato como variables estructurales.

El mercado no requiere segmentación excesiva; bastan grandes categorías.

Existen nichos premium claramente identificables.

La estructura socioeconómica territorial influye directamente en precios.


El análisis multivariado evidencia que el mercado inmobiliario urbano presenta una estructura organizada principalmente en torno a un eje de valorización socioeconómica y una diferenciación espacial significativa. Aunque el mercado muestra alta concentración en un núcleo dominante, existen perfiles extremos que configuran subsegmentos de alto valor. La fuerte asociación entre barrio y estrato confirma la existencia de patrones estructurales de segregación socioeconómica territorial.
